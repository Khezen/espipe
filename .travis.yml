language: go
go:
  - master
install:
  - go build -v ./...

script:
  - echo "" > coverage.txt
  - "
    ex=0 \n
    for d in $(go list ./... | grep -v vendor); do \n
        COV=$(go test -race  -coverprofile=profile.out -covermode=atomic $d | sed  's/[^0-9]*\\([0-9]*\\.[0-9]\\).*/\\1/') | if [[ ( $COV -lt 75 ) ]]; then \n 
          echo expecting test coverage greater than 75 %, got insufficient $COV % for package $d; \n
          if [[ ( $ex -eq 0) ]]; then \n
            ex=1 \n
          fi \n
        fi \n
        if [ $? -gt 0 ]; then \n
          exit 1; \n
        elif [ -f profile.out ]; then \n
          cat profile.out >> coverage.txt \n
          rm profile.out \n
      fi \n
    done\n
    exit $ex"

after_success:
  - bash <(curl -s https://codecov.io/bash)
